<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CineScope ‚Äî FastAPI Recommender</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
  body {
    background: radial-gradient(circle at top, #0d0d0d, #000);
    color: #fff;
    font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, sans-serif;
  }
  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-thumb { background: #2b2b2b; border-radius: 8px; }

  .btn {
    padding: 0.5rem 1rem;
    border-radius: 0.5rem;
    font-weight: 600;
    transition: 0.2s all ease;
  }
  .btn-amber {
    background-color: #f59e0b;
    color: #000;
  }
  .btn-amber:hover {
    background-color: #fbbf24;
  }
  .btn-ghost {
    background-color: rgba(255,255,255,0.1);
    color: #fff;
  }
  .btn-ghost:hover {
    background-color: rgba(255,255,255,0.2);
  }

  .chip {
    display: inline-block;
    padding: 2px 6px;
    font-size: 0.75rem;
    border-radius: 0.25rem;
    background: rgba(255,255,255,0.1);
  }

  .card {
    background-color: #111;
    border-radius: 0.75rem;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.5);
    transition: transform 0.2s, box-shadow 0.2s;
    cursor: default;
  }
  .card:hover {
    transform: scale(1.01);
    box-shadow: 0 4px 12px rgba(0,0,0,0.6);
  }

  .drag-over {
    outline: 2px dashed #f59e0b;
    outline-offset: 4px;
  }
</style>
</head>
<body class="min-h-screen flex flex-col">

  <!-- Navbar -->
  <nav class="bg-black/80 border-b border-white/10 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <span class="text-2xl">üé¨</span>
        <h1 class="text-2xl font-bold tracking-tight text-amber-400">CineScope</h1>
      </div>
      <span class="text-white/50 text-sm">FastAPI Hybrid (SVD + XGBoost)</span>
    </div>
  </nav>

  <!-- Tabs -->
  <div class="max-w-7xl mx-auto w-full px-4 pt-6">
    <div class="inline-flex rounded-xl bg-white/5 p-1">
      <button id="tabDiscover" class="btn btn-amber" aria-selected="true">Discover</button>
      <button id="tabExplore" class="btn btn-ghost">Explore by Example</button>
    </div>
  </div>

  <!-- Main -->
  <main class="max-w-7xl mx-auto w-full px-4 py-6 flex-1">

    <!-- DISCOVER -->
    <section id="panelDiscover" role="tabpanel" aria-labelledby="tabDiscover">
      <h2 class="text-3xl font-bold mb-4">Discover Movies</h2>

      <!-- Controls -->
      <div class="grid md:grid-cols-4 gap-3 mb-4">
        <label class="sr-only" for="q">Search</label>
        <input id="q" class="bg-white/10 rounded-lg px-3 py-2 placeholder-white/50"
               placeholder="Search by title‚Ä¶" />

        <select id="genre" class="bg-white/10 rounded-lg px-3 py-2">
          <option value="">All Genres</option>
        </select>

        <div class="bg-white/10 rounded-lg px-3 py-2 flex items-center gap-2">
          <label class="text-sm text-white/70">Year</label>
          <input id="ymin" type="number" class="w-20 bg-transparent outline-none" placeholder="min" />
          <span class="text-white/40">‚Äì</span>
          <input id="ymax" type="number" class="w-20 bg-transparent outline-none" placeholder="max" />
        </div>

        <select id="sort" class="bg-white/10 rounded-lg px-3 py-2">
          <option value="title">Sort: Title (A‚ÜíZ)</option>
          <option value="year">Sort: Year (new‚Üíold)</option>
          <option value="genres">Sort: Genres</option>
        </select>
      </div>

      <div class="flex items-center gap-2 mb-6">
        <button id="apply" class="btn btn-amber">Apply</button>
        <button id="reset" class="btn btn-ghost">Reset</button>
        <span id="status" class="text-white/50 text-sm ml-2"></span>
      </div>

      <!-- Grid -->
      <div id="grid" class="grid sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5 mb-6" aria-live="polite"></div>

      <!-- Pager -->
      <div class="flex items-center justify-between">
        <button id="prev" class="btn btn-ghost" disabled>‚Üê Prev</button>
        <span id="pageInfo" class="text-white/60 text-sm"></span>
        <button id="next" class="btn btn-ghost">Next ‚Üí</button>
      </div>
    </section>

    <!-- EXPLORE -->
    <section id="panelExplore" role="tabpanel" aria-labelledby="tabExplore" hidden>
      <h2 class="text-3xl font-bold mb-4">Explore by Example</h2>
      <p class="text-white/60 mb-4">Drag movies into the tray, then press <b>Build Suggestions</b>. We‚Äôll combine
        <code>/api/similar</code> results from all seeds and de-duplicate them.</p>

      <!-- Seeds + Actions -->
      <div class="flex flex-wrap items-center gap-3 mb-4">
        <button id="loadSome" class="btn btn-ghost">Load some titles</button>
        <button id="clearSeeds" class="btn btn-ghost">Clear tray</button>
        <button id="build" class="btn btn-amber">Build Suggestions</button>
        <span id="exploreStatus" class="text-white/50 text-sm"></span>
      </div>

      <!-- Seed tray (drop zone) -->
      <div id="tray" class="min-h-24 bg-white/5 border border-white/10 rounded-xl p-3 mb-6"
           aria-label="Seed tray" aria-dropeffect="move">
        <p class="text-white/50 text-sm">Drag movies here‚Ä¶</p>
        <div id="seedList" class="flex flex-wrap gap-2 mt-2"></div>
      </div>

      <!-- Suggestions -->
      <h3 class="text-xl font-semibold mb-3">Suggestions</h3>
      <div id="suggestions" class="grid sm:grid-cols-2 md:grid-cols-3 xl:grid-cols-4 gap-5" aria-live="polite"></div>
    </section>

  </main>

  <footer class="text-center text-white/40 text-sm py-5 border-t border-white/10">
    ¬© 2025 CineScope ‚Äî uses your FastAPI endpoints only
  </footer>

  <script>
    // ---------- config ----------
    const API = "http://127.0.0.1:8000";
    const PAGE_SIZE = 24; // client-side paging

    // ---------- state ----------
    let allMovies = [];       // cached /api/movies
    let filtered = [];        // after filters
    let page = 1;
    let genresSet = new Set();

    // ---------- elements ----------
    const tabDiscover = document.getElementById("tabDiscover");
    const tabExplore  = document.getElementById("tabExplore");
    const panelDiscover = document.getElementById("panelDiscover");
    const panelExplore  = document.getElementById("panelExplore");

    const q = document.getElementById("q");
    const genreSel = document.getElementById("genre");
    const ymin = document.getElementById("ymin");
    const ymax = document.getElementById("ymax");
    const sortSel = document.getElementById("sort");
    const applyBtn = document.getElementById("apply");
    const resetBtn = document.getElementById("reset");
    const grid = document.getElementById("grid");
    const statusEl = document.getElementById("status");
    const prevBtn = document.getElementById("prev");
    const nextBtn = document.getElementById("next");
    const pageInfo = document.getElementById("pageInfo");

    const tray = document.getElementById("tray");
    const seedList = document.getElementById("seedList");
    const suggestions = document.getElementById("suggestions");
    const loadSomeBtn = document.getElementById("loadSome");
    const clearSeedsBtn = document.getElementById("clearSeeds");
    const buildBtn = document.getElementById("build");
    const exploreStatus = document.getElementById("exploreStatus");

    // ---------- helpers ----------
    const sleep = ms => new Promise(r => setTimeout(r, ms));

    function safeText(x) { return (x ?? "").toString(); }
    function getYearFromTitle(t) {
      // MovieLens titles often like "Toy Story (1995)"
      const m = /\((\d{4})\)$/.exec(t || "");
      return m ? Number(m[1]) : undefined;
    }
    function uniqBy(arr, keyFn) {
      const m = new Map();
      for (const x of arr) m.set(keyFn(x), x);
      return [...m.values()];
    }
    function paginate(arr, p, n) {
      const start = (p-1)*n;
      return arr.slice(start, start+n);
    }
    function cardHTML(m) {
      const g = Array.isArray(m.genres) ? m.genres : (safeText(m.genres).split("|").filter(Boolean));
      const year = m.year ?? getYearFromTitle(m.title);
      return `
        <article class="card" draggable="true" data-id="${m.movieId}" aria-grabbed="false">
          <div class="p-4">
            <h3 class="font-semibold text-lg leading-tight line-clamp-2">${safeText(m.title)}</h3>
            <div class="mt-1 space-x-1">${g.slice(0,3).map(x=>`<span class="chip">${x}</span>`).join("")}</div>
            <p class="text-xs text-white/50 mt-2">${year ? "Year: "+year : ""}</p>
            <div class="mt-3 flex gap-2">
              <button class="btn btn-amber text-sm" data-similar="${m.movieId}">Find Similar</button>
              <button class="btn btn-ghost text-sm" data-addseed="${m.movieId}">Add to Tray</button>
            </div>
          </div>
        </article>
      `;
    }
    function miniSeedHTML(m) {
      return `<span class="chip" data-seedid="${m.movieId}" title="${safeText(m.title)}">
                üéØ ${safeText(m.title).slice(0,28)}
                <button class="ml-1 text-white/60" aria-label="Remove seed" data-rmseed="${m.movieId}">‚úï</button>
              </span>`;
    }

    // ---------- tabs ----------
    function showDiscover() {
      tabDiscover.classList.replace("btn-ghost","btn-amber");
      tabExplore.classList.replace("btn-amber","btn-ghost");
      panelDiscover.hidden = false;
      panelExplore.hidden = true;
    }
    function showExplore() {
      tabExplore.classList.replace("btn-ghost","btn-amber");
      tabDiscover.classList.replace("btn-amber","btn-ghost");
      panelExplore.hidden = false;
      panelDiscover.hidden = true;
    }
    tabDiscover.onclick = showDiscover;
    tabExplore.onclick  = showExplore;

    // ---------- fetch movies ----------
    async function loadMovies() {
      statusEl.textContent = "Loading‚Ä¶";
      grid.innerHTML = `<p class="text-white/60">Fetching movies‚Ä¶</p>`;
      try {
        const res = await fetch(`${API}/api/movies?limit=10000`);
        if (!res.ok) throw new Error("Failed to load /api/movies");
        const data = await res.json();
        allMovies = data.map(m => ({
          ...m,
          year: m.year ?? getYearFromTitle(m.title),
          genres: Array.isArray(m.genres) ? m.genres :
                  (typeof m.genres === "string" ? m.genres.split("|").filter(Boolean) : [])
        }));
        // collect genres
        genresSet = new Set();
        allMovies.forEach(m => (m.genres||[]).forEach(g => genresSet.add(g)));
        genreSel.innerHTML = `<option value="">All Genres</option>` +
          [...genresSet].sort().map(g => `<option>${g}</option>`).join("");
        applyFilters(); // initial render
      } catch (e) {
        console.error(e);
        grid.innerHTML = `<p class="text-red-400">‚ö†Ô∏è Could not reach backend. Is <code>uvicorn</code> running?</p>`;
        statusEl.textContent = "Failed to load movies";
      }
    }

    // ---------- filtering + sorting ----------
    function applyFilters() {
      const qv = q.value.trim().toLowerCase();
      const gv = genreSel.value;
      const y0 = Number(ymin.value) || -Infinity;
      const y1 = Number(ymax.value) ||  Infinity;
      const sort = sortSel.value;

      filtered = allMovies.filter(m => {
        const titleOk = !qv || safeText(m.title).toLowerCase().includes(qv);
        const genreOk = !gv || (m.genres || []).includes(gv);
        const year = m.year ?? getYearFromTitle(m.title);
        const yearOk = !year || (year >= y0 && year <= y1);
        return titleOk && genreOk && yearOk;
      });

      if (sort === "title") filtered.sort((a,b)=>safeText(a.title).localeCompare(safeText(b.title)));
      if (sort === "year")  filtered.sort((a,b)=>(b.year||0)-(a.year||0));
      if (sort === "genres") filtered.sort((a,b)=>safeText((a.genres||[]).join(",")).localeCompare(safeText((b.genres||[]).join(","))));

      page = 1;
      renderPage();
    }

    function renderPage() {
      const total = filtered.length;
      const pages = Math.max(1, Math.ceil(total / PAGE_SIZE));
      page = Math.min(Math.max(1, page), pages);
      const items = paginate(filtered, page, PAGE_SIZE);

      if (!total) {
        grid.innerHTML = `<p class="text-white/60">No movies match your filters.</p>`;
      } else {
        grid.innerHTML = items.map(cardHTML).join("");
      }

      statusEl.textContent = `${total.toLocaleString()} movies ¬∑ page ${page}/${pages}`;
      pageInfo.textContent = `Page ${page} of ${pages}`;
      prevBtn.disabled = page <= 1;
      nextBtn.disabled = page >= pages;
    }

    // ---------- events ----------
    applyBtn.onclick = applyFilters;
    resetBtn.onclick = () => { q.value=""; genreSel.value=""; ymin.value=""; ymax.value=""; sortSel.value="title"; applyFilters(); };
    prevBtn.onclick = () => { page--; renderPage(); };
    nextBtn.onclick = () => { page++; renderPage(); };
    q.addEventListener("keydown", (e)=>{ if(e.key==="Enter") applyFilters(); });

    // delegate clicks for ‚ÄúFind Similar‚Äù and ‚ÄúAdd to Tray‚Äù
    grid.addEventListener("click", async (e) => {
      const simBtn = e.target.closest("[data-similar]");
      const addBtn = e.target.closest("[data-addseed]");
      if (simBtn) {
        const id = Number(simBtn.getAttribute("data-similar"));
        await showSimilar(id);
      } else if (addBtn) {
        const id = Number(addBtn.getAttribute("data-addseed"));
        const m = allMovies.find(x => x.movieId === id);
        if (m) addSeed(m);
      }
    });

    // ---------- Similar popup ----------
    async function showSimilar(movieId) {
      statusEl.textContent = "Getting similar movies‚Ä¶";
      try {
        const res = await fetch(`${API}/api/similar?movie_id=${movieId}&k=12`);
        const data = await res.json();
        // Open Explore tab and render suggestions instantly
        showExplore();
        suggestions.innerHTML = data.map(cardHTML).join("");
        statusEl.textContent = "";
      } catch (e) {
        console.error(e);
        statusEl.textContent = "Failed to fetch similar titles";
      }
    }

    // ---------- Explore by Example ----------
    const seeds = new Map(); // movieId -> movie

    function addSeed(m) {
      if (seeds.has(m.movieId)) return;
      seeds.set(m.movieId, m);
      seedList.insertAdjacentHTML("beforeend", miniSeedHTML(m));
      exploreStatus.textContent = `${seeds.size} seed${seeds.size>1?"s":""}`;
    }
    seedList.addEventListener("click",(e)=>{
      const rm = e.target.closest("[data-rmseed]");
      if (rm) {
        const id = Number(rm.getAttribute("data-rmseed"));
        seeds.delete(id);
        rm.parentElement.remove();
        exploreStatus.textContent = `${seeds.size} seed${seeds.size>1?"s":""}`;
      }
    });

    // Drag from discover grid to tray
    grid.addEventListener("dragstart", (e)=>{
      const card = e.target.closest("[draggable=true]");
      if (!card) return;
      e.dataTransfer.setData("text/plain", card.getAttribute("data-id"));
      e.dataTransfer.effectAllowed = "move";
    });
    tray.addEventListener("dragover",(e)=>{ e.preventDefault(); tray.classList.add("drag-over"); });
    tray.addEventListener("dragleave",()=> tray.classList.remove("drag-over"));
    tray.addEventListener("drop",(e)=>{
      e.preventDefault(); tray.classList.remove("drag-over");
      const id = Number(e.dataTransfer.getData("text/plain"));
      const m = allMovies.find(x => x.movieId === id);
      if (m) addSeed(m);
    });

    loadSomeBtn.onclick = ()=>{
      // pick 6 random items from current filtered set (or allMovies)
      const source = filtered.length ? filtered : allMovies;
      for (const m of source.slice(0, 6)) addSeed(m);
    };
    clearSeedsBtn.onclick = ()=>{
      seeds.clear(); seedList.innerHTML=""; exploreStatus.textContent = "";
      suggestions.innerHTML = "";
    };

    buildBtn.onclick = async () => {
      if (!seeds.size) { exploreStatus.textContent = "Add some seeds first."; return; }
      exploreStatus.textContent = "Building suggestions‚Ä¶";
      suggestions.innerHTML = `<p class="text-white/60">Fetching recommendations‚Ä¶</p>`;
      try {
        const all = [];
        // Query the API for each seed (in small bursts)
        for (const m of seeds.values()) {
          const res = await fetch(`${API}/api/similar?movie_id=${m.movieId}&k=20`);
          const js = await res.json();
          all.push(...js);
          await sleep(100); // gentle delay
        }
        // De-duplicate by movieId and remove any that are also seeds
        const uniques = uniqBy(all, x => x.movieId).filter(x => !seeds.has(x.movieId));
        suggestions.innerHTML = uniques.length
          ? uniques.slice(0, 40).map(cardHTML).join("")
          : `<p class="text-white/60">No suggestions found from the selected seeds.</p>`;
        exploreStatus.textContent = `Got ${uniques.length} suggestions`;
      } catch (e) {
        console.error(e);
        suggestions.innerHTML = `<p class="text-red-400">Failed to build suggestions.</p>`;
        exploreStatus.textContent = "Error fetching suggestions";
      }
    };

    // ---------- init ----------
    (async function init() {
      try {
        const h = await fetch(`${API}/health`).then(r=>r.json()).catch(()=>null);
        if (!h || (h.status && h.status !== "ok")) console.warn("Health:", h);
      } catch (_) {}
      await loadMovies();
    })();
  </script>
</body>
</html>


